<Window x:Class="GroupeV.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:GroupeV"
    xmlns:vm="clr-namespace:GroupeV.ViewModels"
    xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.WPF;assembly=LiveChartsCore.SkiaSharpView.WPF"
    mc:Ignorable="d"
    Title="GroupeV — Tableau de Bord" 
    MinHeight="600" MinWidth="900"
    Height="850" Width="1440"
    Background="{StaticResource NeuBackgroundBrush}"
    WindowStartupLocation="CenterScreen"
    Loaded="MainWindow_Loaded">

    <Window.DataContext>
        <vm:DashboardViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <Storyboard x:Key="FadeInStoryboard">
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                             From="0" To="1" Duration="0:0:0.6">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ═══ HEADER ═══ -->
        <Border Grid.Row="0" Style="{StaticResource NeuCard}" CornerRadius="0,0,24,24" Padding="28,18" Margin="0,0,0,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <Border Style="{StaticResource NeuStatCard}" CornerRadius="16" Padding="10" Width="48" Height="48"
                            Margin="0,0,16,0" VerticalAlignment="Center">
                        <TextBlock Text="€" FontSize="22" FontWeight="Bold" 
                                   Foreground="{StaticResource NeuAccentBrush}"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock FontFamily="{StaticResource NeuFontFamily}" FontSize="22" FontWeight="Bold" 
                                   Foreground="{StaticResource NeuTextPrimaryBrush}"
                                   Text="Centre de Commande Vendeur"/>
                        <TextBlock Text="{Binding WelcomeMessage}" 
                                   FontFamily="{StaticResource NeuFontFamily}" FontSize="13" 
                                   Foreground="{StaticResource NeuTextSecondaryBrush}" Margin="0,3,0,0"/>
                    </StackPanel>
                </StackPanel>

                <StackPanel Grid.Column="1" VerticalAlignment="Center" Orientation="Horizontal">
                    <Ellipse Width="10" Height="10" Fill="{StaticResource NeuSuccessBrush}" Margin="0,0,8,0"/>
                    <TextBlock Text="En ligne" FontFamily="{StaticResource NeuFontFamily}" FontSize="13" 
                               Foreground="{StaticResource NeuSuccessBrush}" FontWeight="SemiBold"
                               VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ═══ STATS CARDS (adaptive wrap) ═══ -->
        <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled" Margin="24,16,24,8">
            <UniformGrid Rows="1" MinWidth="800">
                <Border Style="{StaticResource NeuStatCard}" Margin="0,0,10,0">
                    <StackPanel>
                        <TextBlock Text="Mes Produits" FontFamily="{StaticResource NeuFontFamily}" FontSize="12" 
                                   Foreground="{StaticResource NeuTextSecondaryBrush}" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding TotalProduits}" FontFamily="{StaticResource NeuFontFamily}" 
                                   FontSize="34" FontWeight="Bold" Foreground="{StaticResource NeuAccentBrush}" Margin="0,6,0,0"/>
                        <TextBlock Text="dans mon catalogue" FontFamily="{StaticResource NeuFontFamily}" FontSize="11" 
                                   Foreground="{StaticResource NeuTextSecondaryBrush}" Margin="0,4,0,0"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource NeuStatCard}" Margin="0,0,10,0">
                    <StackPanel>
                        <TextBlock Text="Catégories" FontFamily="{StaticResource NeuFontFamily}" FontSize="12" 
                                   Foreground="{StaticResource NeuTextSecondaryBrush}" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding TotalCategories}" FontFamily="{StaticResource NeuFontFamily}" 
                                   FontSize="34" FontWeight="Bold" Foreground="{StaticResource NeuWarningBrush}" Margin="0,6,0,0"/>
                        <TextBlock Text="catégories de produits" FontFamily="{StaticResource NeuFontFamily}" FontSize="11" 
                                   Foreground="{StaticResource NeuTextSecondaryBrush}" Margin="0,4,0,0"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource NeuStatCard}" Margin="0,0,10,0">
                    <StackPanel>
                        <TextBlock Text="Prix Moyen" FontFamily="{StaticResource NeuFontFamily}" FontSize="12" 
                                   Foreground="{StaticResource NeuTextSecondaryBrush}" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding AveragePrice}" FontFamily="{StaticResource NeuMonoFont}" 
                                   FontSize="24" FontWeight="Bold" Foreground="{StaticResource NeuSuccessBrush}" Margin="0,6,0,0"/>
                        <TextBlock Text="prix moyen global" FontFamily="{StaticResource NeuFontFamily}" FontSize="11" 
                                   Foreground="{StaticResource NeuTextSecondaryBrush}" Margin="0,4,0,0"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource NeuStatCard}">
                    <StackPanel>
                        <TextBlock Text="Vendeur Actif" FontFamily="{StaticResource NeuFontFamily}" FontSize="12" 
                                   Foreground="{StaticResource NeuTextSecondaryBrush}" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding ActiveSellerName}" FontFamily="{StaticResource NeuFontFamily}" 
                                   FontSize="18" FontWeight="Bold" Foreground="{StaticResource NeuTextPrimaryBrush}" 
                                   TextWrapping="Wrap" Margin="0,6,0,0"/>
                        <TextBlock Text="{Binding ActiveSellerEmail}" FontFamily="{StaticResource NeuFontFamily}" FontSize="11" 
                                   Foreground="{StaticResource NeuTextSecondaryBrush}" Margin="0,4,0,0" TextTrimming="CharacterEllipsis"/>
                    </StackPanel>
                </Border>
            </UniformGrid>
        </ScrollViewer>

        <!-- ═══ MAIN CONTENT ═══ -->
        <Grid Grid.Row="2" Margin="24,8,24,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="240" MinWidth="180"/>
                <ColumnDefinition Width="*" MinWidth="380"/>
                <ColumnDefinition Width="320" MinWidth="260"/>
            </Grid.ColumnDefinitions>

            <!-- LEFT: NAVIGATION -->
            <Border Grid.Column="0" Style="{StaticResource NeuCard}" Margin="0,0,12,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="Base de données" FontFamily="{StaticResource NeuFontFamily}" FontSize="12" 
                                   FontWeight="Bold" Foreground="{StaticResource NeuTextPrimaryBrush}" Margin="0,0,0,10"/>

                        <Button x:Name="TestConnectionButton" Content="Tester Connexion" 
                                Click="TestConnectionButton_Click" Style="{StaticResource NeuButton}" FontSize="12" Padding="12,8"/>
                        <Button x:Name="ShowDiagnosticsButton" Content="Afficher Diagnostics" 
                                Click="ShowDiagnosticsButton_Click" Style="{StaticResource NeuButton}" FontSize="12" Padding="12,8"/>
                        <Button x:Name="HealthCheckButton" Content="Vérification Santé" 
                                Click="HealthCheckButton_Click" Style="{StaticResource NeuButton}" FontSize="12" Padding="12,8"/>

                        <Border Height="1" Background="{StaticResource NeuDarkShadowBrush}" Margin="0,12" Opacity="0.5"/>

                        <TextBlock Text="Opérations Données" FontFamily="{StaticResource NeuFontFamily}" FontSize="12" 
                                   FontWeight="Bold" Foreground="{StaticResource NeuTextPrimaryBrush}" Margin="0,0,0,10"/>

                        <Button x:Name="AddProductButton" Content="Ajouter Produit" 
                                Click="AddProductButton_Click" Style="{StaticResource NeuButtonAccent}" FontSize="12" Padding="12,8"/>
                        <Button x:Name="EditProductButton" Content="Modifier Produit" 
                                Click="EditProductButton_Click" Style="{StaticResource NeuButton}" FontSize="12" Padding="12,8"/>
                        <Button x:Name="ExportButton" Content="Exporter Données" 
                                Click="ExportButton_Click" Style="{StaticResource NeuButton}" FontSize="12" Padding="12,8"/>

                        <Border Height="1" Background="{StaticResource NeuDarkShadowBrush}" Margin="0,12" Opacity="0.5"/>

                        <Button x:Name="LogoutButton" Content="Déconnexion" 
                                Click="LogoutButton_Click" Style="{StaticResource NeuButtonDanger}" FontSize="12" Padding="12,8"/>

                        <Border Height="1" Background="{StaticResource NeuDarkShadowBrush}" Margin="0,12" Opacity="0.5"/>

                        <TextBlock Text="Statistiques Rapides" FontFamily="{StaticResource NeuFontFamily}" FontSize="12" 
                                   FontWeight="Bold" Foreground="{StaticResource NeuTextPrimaryBrush}" Margin="0,0,0,8"/>
                        <Border Style="{StaticResource NeuCardInset}" Padding="12">
                            <TextBlock Text="{Binding QuickStats}" FontFamily="{StaticResource NeuMonoFont}" FontSize="10" 
                                       Foreground="{StaticResource NeuTextSecondaryBrush}" TextWrapping="Wrap" LineHeight="16"/>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- CENTER: TABS (Produits / Factures) -->
            <Border Grid.Column="1" Style="{StaticResource NeuCard}" Margin="0,0,12,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Tab buttons -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,12">
                        <Button x:Name="TabProduitsBtn" Content="📦 Mes Produits" 
                                Click="TabProduits_Click" Style="{StaticResource NeuButtonAccent}"
                                Height="36" FontSize="13" Margin="0,0,8,0"/>
                        <Button x:Name="TabFacturesBtn" Content="📄 Factures" 
                                Click="TabFactures_Click" Style="{StaticResource NeuButton}"
                                Height="36" FontSize="13"/>
                    </StackPanel>

                    <!-- Search bar -->
                    <TextBox Grid.Row="1" x:Name="SearchBox" Style="{StaticResource NeuTextBox}" 
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                             Height="40" FontSize="13" Margin="0,0,0,12"/>

                    <!-- PRODUITS TAB -->
                    <Border Grid.Row="2" x:Name="ProduitsTab" Style="{StaticResource NeuCardInset}" Padding="0" CornerRadius="14">
                        <DataGrid x:Name="SalesDataGrid"
                                  Style="{StaticResource NeuDataGrid}"
                                  ItemsSource="{Binding FilteredProduits}"
                                  SelectedItem="{Binding SelectedProduct, Mode=TwoWay}"
                                  ColumnHeaderStyle="{StaticResource NeuDataGridColumnHeader}"
                                  CellStyle="{StaticResource NeuDataGridCell}"
                                  RowStyle="{StaticResource NeuDataGridRow}"
                                  RowHeight="50">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding IdProduit}" Width="55"/>
                                <DataGridTemplateColumn Header="Image" Width="60">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Width="40" Height="40" CornerRadius="8" 
                                                    Background="{StaticResource NeuDarkShadowBrush}" ClipToBounds="True">
                                                <Image Source="{Binding ImageAbsolutePath}" Stretch="UniformToFill"
                                                       RenderOptions.BitmapScalingMode="HighQuality"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Produit" Binding="{Binding Description}" Width="*" MinWidth="150"/>
                                <DataGridTextColumn Header="Prix" Binding="{Binding PrixFormate}" Width="100"/>
                                <DataGridTemplateColumn Header="Type" Width="110">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="10" Padding="8,4" HorizontalAlignment="Left" Opacity="0.9">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding TypeVente}" Value="0">
                                                                <Setter Property="Background" Value="{StaticResource NeuSuccessBrush}"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding TypeVente}" Value="1">
                                                                <Setter Property="Background" Value="{StaticResource NeuWarningBrush}"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding TypeVente}" Value="2">
                                                                <Setter Property="Background" Value="{StaticResource NeuDangerBrush}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding TypeVenteBadge}" FontSize="11" FontWeight="SemiBold"
                                                           Foreground="White" FontFamily="{StaticResource NeuFontFamily}"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn Header="Catégorie" Width="130">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Background="{StaticResource NeuAccentBrush}" CornerRadius="10" 
                                                    Padding="8,4" HorizontalAlignment="Left" Opacity="0.85">
                                                <TextBlock Text="{Binding CategorieNom}" FontSize="11" FontWeight="SemiBold"
                                                           Foreground="White" FontFamily="{StaticResource NeuFontFamily}"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Créé le" Binding="{Binding CreatedAt, StringFormat=dd/MM/yyyy}" Width="95"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Border>

                    <!-- FACTURES TAB -->
                    <Border Grid.Row="2" x:Name="FacturesTab" Style="{StaticResource NeuCardInset}" Padding="0" CornerRadius="14"
                            Visibility="Collapsed">
                        <DataGrid Style="{StaticResource NeuDataGrid}"
                                  ItemsSource="{Binding Factures}"
                                  ColumnHeaderStyle="{StaticResource NeuDataGridColumnHeader}"
                                  CellStyle="{StaticResource NeuDataGridCell}"
                                  RowStyle="{StaticResource NeuDataGridRow}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="N°" Binding="{Binding IdPrevente}" Width="55"/>
                                <DataGridTextColumn Header="Article" Binding="{Binding ProduitDescription}" Width="*" MinWidth="150"/>
                                <DataGridTextColumn Header="Prix Prévente" Binding="{Binding PrixFormate}" Width="110"/>
                                <DataGridTextColumn Header="Qté Min" Binding="{Binding NombreMin}" Width="70"/>
                                <DataGridTemplateColumn Header="Statut" Width="120">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="10" Padding="8,4" HorizontalAlignment="Left" Opacity="0.9"
                                                    Background="{StaticResource NeuWarningBrush}">
                                                <TextBlock Text="{Binding StatutBadge}" FontSize="11" FontWeight="SemiBold"
                                                           Foreground="White" FontFamily="{StaticResource NeuFontFamily}"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Date Limite" Binding="{Binding DateLimiteFormate}" Width="100"/>
                                <DataGridTextColumn Header="Créé le" Binding="{Binding CreatedAt, StringFormat=dd/MM/yyyy}" Width="95"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Border>
                </Grid>
            </Border>

            <!-- RIGHT: CHARTS & ANALYTICS -->
            <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <Border Style="{StaticResource NeuCard}" Margin="0,0,0,12">
                        <StackPanel>
                            <TextBlock Text="Répartition Catégories" FontFamily="{StaticResource NeuFontFamily}" 
                                       FontSize="14" FontWeight="Bold" Foreground="{StaticResource NeuTextPrimaryBrush}" Margin="0,0,0,10"/>
                            <lvc:PieChart x:Name="CategoriesPieChart" Height="200" Background="Transparent" LegendPosition="Right"/>
                        </StackPanel>
                    </Border>

                    <Border Style="{StaticResource NeuCard}" Margin="0,0,0,12">
                        <StackPanel>
                            <TextBlock Text="Prix Moyens par Catégorie" FontFamily="{StaticResource NeuFontFamily}" 
                                       FontSize="14" FontWeight="Bold" Foreground="{StaticResource NeuTextPrimaryBrush}" Margin="0,0,0,10"/>
                            <lvc:CartesianChart x:Name="PrixMoyensChart" Height="200" Background="Transparent"/>
                        </StackPanel>
                    </Border>

                    <Border Style="{StaticResource NeuCard}" Margin="0,0,0,12">
                        <StackPanel>
                            <TextBlock Text="Analytics" FontFamily="{StaticResource NeuFontFamily}" 
                                       FontSize="14" FontWeight="Bold" Foreground="{StaticResource NeuTextPrimaryBrush}" Margin="0,0,0,12"/>
                            <Border Style="{StaticResource NeuCardInset}" Margin="0,0,0,10">
                                <StackPanel>
                                    <TextBlock Text="Produit le plus cher" FontFamily="{StaticResource NeuFontFamily}" FontSize="11" 
                                               Foreground="{StaticResource NeuWarningBrush}" FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding MostExpensiveProduct}" FontFamily="{StaticResource NeuFontFamily}" FontSize="14" 
                                               FontWeight="Bold" Foreground="{StaticResource NeuTextPrimaryBrush}" TextWrapping="Wrap" Margin="0,4,0,0"/>
                                    <TextBlock Text="{Binding MostExpensivePrice}" FontFamily="{StaticResource NeuMonoFont}" FontSize="13" 
                                               Foreground="{StaticResource NeuWarningBrush}"/>
                                </StackPanel>
                            </Border>
                            <Border Style="{StaticResource NeuCardInset}" Margin="0,0,0,10">
                                <StackPanel>
                                    <TextBlock Text="Produit le moins cher" FontFamily="{StaticResource NeuFontFamily}" FontSize="11" 
                                               Foreground="{StaticResource NeuAccentBrush}" FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding LeastExpensiveProduct}" FontFamily="{StaticResource NeuFontFamily}" FontSize="14" 
                                               FontWeight="Bold" Foreground="{StaticResource NeuTextPrimaryBrush}" TextWrapping="Wrap" Margin="0,4,0,0"/>
                                    <TextBlock Text="{Binding LeastExpensivePrice}" FontFamily="{StaticResource NeuMonoFont}" FontSize="13" 
                                               Foreground="{StaticResource NeuAccentBrush}"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Border>

                    <Border Style="{StaticResource NeuCard}">
                        <StackPanel>
                            <TextBlock Text="Activité Récente" FontFamily="{StaticResource NeuFontFamily}" 
                                       FontSize="14" FontWeight="Bold" Foreground="{StaticResource NeuTextPrimaryBrush}" Margin="0,0,0,10"/>
                            <StackPanel x:Name="ActivityHeatmapPanel"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- ═══ FOOTER ═══ -->
        <Border Grid.Row="3" Style="{StaticResource NeuCard}" CornerRadius="24,24,0,0" Padding="24,12" Margin="0,4,0,0">
            <Grid>
                <TextBlock Text="{Binding StatusMessage}" FontFamily="{StaticResource NeuMonoFont}" FontSize="12" 
                           Foreground="{StaticResource NeuTextSecondaryBrush}" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding RecordCount}" FontFamily="{StaticResource NeuMonoFont}" FontSize="12" 
                           Foreground="{StaticResource NeuTextSecondaryBrush}" HorizontalAlignment="Right" VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- ═══ TOAST NOTIFICATION OVERLAY ═══ -->
        <Border Grid.RowSpan="4" Style="{StaticResource NeuToast}"
                Visibility="{Binding IsToastVisible, Converter={StaticResource BoolToVis}}"
                Panel.ZIndex="100">
            <TextBlock Text="{Binding ToastMessage}" FontFamily="{StaticResource NeuFontFamily}" FontSize="13"
                       Foreground="{StaticResource NeuTextPrimaryBrush}" TextWrapping="Wrap" MaxWidth="320"/>
        </Border>
    </Grid>
</Window>
